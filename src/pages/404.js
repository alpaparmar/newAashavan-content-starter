import React from 'react'
import { sourcebitDataClient } from 'sourcebit-target-next'
import { withRemoteDataUpdates } from 'sourcebit-target-next/with-remote-data-updates'
import { getComponent } from '../components/components-registry';
import { resolveStaticProps } from '../utils/static-props-resolvers';

// copied from [[...slug]].js
function Page(props) {
    const { page, site } = props;
    const { layout } = page;

    if (!layout) {
        throw new Error(`page has no layout, page '${props.path}'`);
    }
    const PageLayout = getComponent(layout);
    if (!PageLayout) {
        throw new Error(`no page layout matching the layout: ${layout}`);
    }
    return <PageLayout page={page} site={site} />;
}

// copied from [[...slug]].js
export async function getStaticProps({ params }) {
    // The "data" object is generated by sourcebit.js and cached inside .sourcebit-nextjs-cache.json
    const data = await sourcebitDataClient.getData();
    const urlPath = '/404'; // hard-coded to /404 since "+ (params.slug || []).join('/');" wasn't working
    const props = await resolveStaticProps(urlPath, data);
    return { props };
}

export default withRemoteDataUpdates(Page);